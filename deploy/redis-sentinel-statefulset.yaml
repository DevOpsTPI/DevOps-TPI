apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-sentinel
spec:
  serviceName: redis-sentinel
  replicas: 3   # 3 sentinels para quorum (minimo 2 para failover)
  selector:
    matchLabels:
      app: redis-sentinel
  template:
    metadata:
      labels:
        app: redis-sentinel
        tier: database
    spec:
      # Permitir que corra en cualquiera de los 3 nodos worker
      nodeSelector:
        node-type: application
      # Init container para configurar Sentinel
      initContainers:
        - name: init-sentinel
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -ex
              # Esperar a que Redis master este disponible via DNS
              echo "Esperando a que redis-0.redis este disponible..."
              until nc -z redis-0.redis 6379; do
                echo "Esperando conexion a redis-0.redis:6379..."
                sleep 2
              done
              echo "Redis master disponible!"

              # Obtener la IP de redis-0 usando ping
              REDIS_IP=$(ping -c 1 redis-0.redis | head -1 | sed 's/.*(\(.*\)).*/\1/')
              echo "IP de redis-0: $REDIS_IP"

              # Verificar que obtuvimos una IP valida (formato x.x.x.x)
              if ! echo "$REDIS_IP" | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$' > /dev/null; then
                echo "ERROR: IP invalida obtenida: $REDIS_IP"
                exit 1
              fi

              # Crear configuracion de Sentinel con la IP
              cat > /etc/redis/sentinel.conf <<EOF
              bind 0.0.0.0
              port 26379
              protected-mode no
              sentinel monitor mymaster $REDIS_IP 6379 2
              sentinel down-after-milliseconds mymaster 5000
              sentinel parallel-syncs mymaster 1
              sentinel failover-timeout mymaster 10000
              EOF

              echo "Sentinel configurado para monitorear mymaster en $REDIS_IP"
          volumeMounts:
            - name: config
              mountPath: /etc/redis
      containers:
        - name: sentinel
          image: redis:7-alpine
          command:
            - redis-sentinel
            - /etc/redis/sentinel.conf
          ports:
            - containerPort: 26379
              name: sentinel
          volumeMounts:
            - name: config
              mountPath: /etc/redis
          resources:
            requests:
              cpu: "25m"
              memory: "64Mi"
            limits:
              cpu: "50m"
              memory: "128Mi"
          livenessProbe:
            tcpSocket:
              port: 26379
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            exec:
              command:
                - redis-cli
                - -p
                - "26379"
                - ping
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: config-map
          configMap:
            name: redis-config
        - name: config
          emptyDir: {}
